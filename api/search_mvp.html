<!DOCTYPE html>
<html>
<head>
    <title>Search and Autocomplete Demo</title>
    <style>
    canvas{

    width:1000px !important;
    height:600px !important;

    }

    #compare-results table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }
    #compare-results th, #compare-results td {
        border: 1px solid #ccc;
        padding: 8px;
        text-align: left;
    }
    #compare-results th {
        background-color: #f2f2f2;
    }
    #compare-chart {
        margin-top: 20px;
    }
    #autocomplete-container {
        position: relative;
    }
    #autocomplete-results {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        border: 1px solid #ccc;
        border-top: none;
        overflow-y: auto;
        background: white;
        z-index: 1000;
        display: none;
    }
    #autocomplete-results li {
        padding: 8px;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        justify-content: center;
        height: 50px;
    }
    #autocomplete-results li.highlighted {
        background-color: #ddd;
    }

    .stage-name {
        font-size: 12px;
        color: grey;
    }
    #search-results {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }
    .profile-group {
        width: 100%;
    }
    .profile-headline {
        font-size: 24px;
        margin-bottom: 10px;
        color: grey;
    }
    .results {
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
    }
    .result-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        width: 220px; /* Fixed size */
        padding: 0 5px;
    }
    .result-item img {
        width: 200px;
        height: 200px;
        border: 10px solid white;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        margin-bottom: 10px;
    }
    .result-item .profile-name,
    .result-item .profile-date,
    .result-item .profile-id {
        padding-left: 10px;
        padding-right: 10px;
        font-size: 14px;
        color: grey;
        word-wrap: break-word; /* Allow text to break */
        width: 100%; /* Ensure text takes full width */
        box-sizing: border-box; /* Include padding/border in element's width/height */
    }

    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <h1>Search and Autocomplete Demo</h1>
    <h2>Compare Histories</h2>
        <form id="compare-form">
            <label for="history_ids">History IDs (comma separated):</label>
            <input type="text" id="history_ids" name="history_ids"><br><br>

            <input type="button" value="Compare" onclick="performCompare()">
        </form>
        <div class="chart-container">
            <canvas id="combined-chart"></canvas>
        </div>

        <div id="compare-results"></div>

    <h2>Search</h2>
    <form id="search-form">

        <label for="date_start">Start Date:</label>
        <input type="date" id="date_start" name="date_start"><br><br>

        <label for="date_end">End Date:</label>
        <input type="date" id="date_end" name="date_end"><br><br>
        
        <label for="group_by">Group By:</label>
        <select id="group_by" name="group_by">
            <option value="none">None</option>
            <option value="day">Day</option>
            <option value="profile">Profile</option>
            <option value="both">Both</option>
        </select><br><br>
        <label for="query">Profile Name:</label>
        <input type="text" id="query" name="query" autocomplete="off" oninput="performAutocomplete()" onfocus="performAutocomplete()"><br><br>
        
        <div id="autocomplete-container">
            <ul id="autocomplete-results"></ul>
        </div>


        <input type="button" value="Search" onclick="performSearch()">
    </form>
    <div id="search-results"></div>
    
    <script>
        function performSearch() {
            const form = document.getElementById('search-form');
            const formData = new FormData(form);
            const params = new URLSearchParams(formData);

            fetch('/search?' + params.toString())
                .then(response => response.json())
                .then(data => {
                    
                    const resultsContainer = document.getElementById('search-results');
                    resultsContainer.innerHTML = ''; // Clear previous results

                    const groupBy = formData.get('group_by');
                    let currentGroup = null;
                    let profileContainer = null;
                    let results = null;

                    data.forEach(item => {
                        let itemGroup = '';
                        var headline = ''
                        if (groupBy === 'profile') {
                            itemGroup = item.profile_id;
                            headline = item.profile_name;
                        } else if (groupBy === 'day') {
                            itemGroup = new Date(item.time).toLocaleDateString();
                            headline = itemGroup;
                        } else if (groupBy === 'both') {
                            const day = new Date(item.time).toLocaleDateString();
                            itemGroup = item.profile_id + day;
                            headline = `${item.profile_name} : ${day}`;
                        } else {
                            itemGroup = 'None';
                        }
                        if (itemGroup !== currentGroup) {
                            currentGroup = itemGroup;
                            currentProfile = item.profile_id;

                            // Create a new container for the current profile group
                            profileContainer = document.createElement('div');
                            profileContainer.className = 'profile-group';

                            // Create a headline for the current profile
                            const profileHeadline = document.createElement('h2');
                            profileHeadline.className = 'profile-headline';
                            profileHeadline.textContent = headline;
                            profileContainer.appendChild(profileHeadline);
                            
                                                    
                            results = document.createElement('div');
                            results.className = 'results';
                            profileContainer.appendChild(results);

                            resultsContainer.appendChild(profileContainer);
                        }

                        const resultItem = document.createElement('div');
                        resultItem.className = 'result-item';
                resultItem.onmouseover = () => {
                    resultItem.style.transform = 'scale(1.05)';
                };

                resultItem.onmouseout = () => {
                    resultItem.style.transform = 'scale(1)';
                };

                resultItem.onclick = () => {
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                    addToCompare(item.dbkey);
                };
                        const img = document.createElement('img');
                        var url = "http://localhost:8080";
                        if (!item.display_image.startsWith("/api/"))
                            url += "/api/v1/profile/image/";
                        img.src = url + item.display_image;
                        resultItem.appendChild(img);

                        const profileName = document.createElement('div');
                        profileName.className = 'profile-name';
                        profileName.textContent = item.profile_name;
                        resultItem.appendChild(profileName);

                        const profileDate = document.createElement('div');
                        profileDate.className = 'profile-date';
                        profileDate.textContent = new Date(item.time).toLocaleString();
                        resultItem.appendChild(profileDate);

                        const profileId = document.createElement('div');
                        profileId.className = 'profile-id';
                        profileId.textContent = 'history ID: ' + item.dbkey;
                        resultItem.appendChild(profileId);

                        results.appendChild(resultItem);
                    });
                    
                });
        }
        function addToCompare(number) {
            const compareForm = document.getElementById('compare-form');
            const input = compareForm.querySelector('input[name="history_ids"]');
            let currentValue = input.value ? input.value.split(',') : [];

            if (!currentValue.includes(String(number))) {
                currentValue.push(number);
                input.value = currentValue.join(',');
                performCompare();
            }
        }

        let currentIndex = 0;

        function performAutocomplete() {
            const prefix = document.getElementById('query').value;
            
            fetch('/autocomplete?prefix=' + encodeURIComponent(prefix))
                .then(response => response.json())
                .then(data => {
                    const resultsContainer = document.getElementById('autocomplete-results');
                    resultsContainer.style.display="block"
                    resultsContainer.innerHTML = ''; // Clear previous results
                    currentIndex = 0;
                    
                    // Add the current content of the profile name field into the dropdown

                    const currentInputItem = document.createElement('li');
                    const currentInputText = document.createElement('span');
                    currentInputText.textContent = prefix;
                    currentInputItem.appendChild(currentInputText);
                    currentInputItem.onclick = () => {
                        document.getElementById('query').value = prefix;
                        resultsContainer.innerHTML = ''; // Clear results after selection
                        resultsContainer.style.display="none"

                        performSearch();
                    };
                    resultsContainer.appendChild(currentInputItem);
                    
                    data.forEach((item, index) => {
                        const listItem = document.createElement('li');
                        const profileName = document.createElement('span');
                        profileName.textContent = item.profile;
                        listItem.appendChild(profileName);
                        
                        if (item.type === 'stage') {
                            const stageName = document.createElement('span');
                            stageName.textContent = `stage: ${item.name}`;
                            stageName.className = 'stage-name';
                            listItem.appendChild(stageName);
                        }
                        
                        listItem.onclick = () => {
                            document.getElementById('query').value = item.profile;
                            resultsContainer.innerHTML = ''; // Clear results after selection
                            resultsContainer.style.display="none"
                            performSearch();
                        };
                        resultsContainer.appendChild(listItem);
                    });
                    const items = resultsContainer.getElementsByTagName('li');
                    updateHighlight(items)
                });
        }

        document.getElementById('query').addEventListener('keydown', function(event) {
            console.log(event)
            const resultsContainer = document.getElementById('autocomplete-results');
            const items = resultsContainer.getElementsByTagName('li');
            updateHighlight(items)
            if (event.key === 'ArrowDown') {
                currentIndex = (currentIndex + 1) % items.length;
                updateHighlight(items);
            } else if (event.key === 'ArrowUp') {
                currentIndex = (currentIndex - 1 + items.length) % items.length;
                updateHighlight(items);
            } else if (event.key === 'Enter') {
                event.preventDefault(); // Prevent form submission
                if (currentIndex > -1 && items.length > currentIndex) {
                    items[currentIndex].click();
                } else {
                    performSearch();
                }
            } 
        });

        function updateHighlight(items) {
            for (let i = 0; i < items.length; i++) {
                items[i].classList.remove('highlighted');
            }
            if (currentIndex > -1 && items.length > currentIndex) {
                console.log(items.length)
                console.log(currentIndex)
                items[currentIndex].classList.add('highlighted');
                items[currentIndex].scrollIntoView({ block: 'nearest' });
            }
        }

        function performCompare() {
            const form = document.getElementById('compare-form');
            const formData = new FormData(form);
            const params = new URLSearchParams(formData);
            
            fetch('/compare?' + params.toString())
                .then(response => response.json())
                .then(data => {
                    const resultsContainer = document.getElementById('compare-results');
                    resultsContainer.innerHTML = ''; // Clear previous results
                    const table = document.createElement('table');
                    const thead = document.createElement('thead');
                    const tbody = document.createElement('tbody');

                    // Create table headers
                    const headers = ['History ID', 'History DB Key', 'Profile Name', 'Profile ID', 'Time'];
                    const headerRow = document.createElement('tr');
                    headers.forEach(header => {
                        const th = document.createElement('th');
                        th.textContent = header;
                        headerRow.appendChild(th);
                    });
                    thead.appendChild(headerRow);
                    table.appendChild(thead);

                    const compareDataPoints = [];

                    // Create table rows
                    data.forEach(item => {
                        
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${item.id}</td>
                                <td>${item.db_key}</td>
                                <td>${item.profile.name}</td>
                                <td>${item.profile.id}</td>
                                <td>${new Date(item.time).toLocaleString()}</td>
                            `;
                            tbody.appendChild(row);
                    
                    });

                    table.appendChild(tbody);
                    resultsContainer.appendChild(table);
                    
                    data.forEach(item => {
                        const offset = Math.random();
                        const dataPoints = {
                            label: item.profile.name,
                            data: {
                                pressure: [],
                                flow: [],
                                weight: [],
                                temperature: []
                            }
                        };
                        item.data.forEach(entry => {
                            dataPoints.data.pressure.push({ x: entry.time, y: entry.shot.pressure*(offset*8) });
                            dataPoints.data.flow.push({ x: entry.time, y: entry.shot.flow*(offset*8) });
                            dataPoints.data.weight.push({ x: entry.time, y: entry.shot.weight*(offset*8)     });
                            dataPoints.data.temperature.push({ x: entry.time, y: entry.shot.temperature*offset });
                        });
                        compareDataPoints.push(dataPoints);
                    });

                    renderCombinedChart(compareDataPoints);

                });
        }
        document.getElementById('history_ids').addEventListener('keydown', function(event) {
            if (event.key === 'Enter' && document.getElementById('autocomplete-results').style.display === 'none') {
                event.preventDefault();
                performSearch();
            }
        });
        function getRandomColor() {
            const letters = '0123456789ABCDEF';
            let color = '#';
            for (let i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }

        var combinedChart = null;
        function renderCombinedChart(dataSets) {
            const combinedCanvas = document.getElementById('combined-chart');

            const datasets = [];

            dataSets.forEach(dataSet => {
                datasets.push(
                    {
                        label: `${dataSet.label} - Pressure`,
                        data: dataSet.data.pressure,
                        borderColor: getRandomColor(),
                        fill: false,
                    },
                    {
                        label: `${dataSet.label} - Flow`,
                        data: dataSet.data.flow,
                        borderColor: getRandomColor(),
                        fill: false,
                    },
                    {
                        label: `${dataSet.label} - Weight`,
                        data: dataSet.data.weight,
                        borderColor: getRandomColor(),
                        fill: false,
                    },
                    {
                        label: `${dataSet.label} - Temperature`,
                        data: dataSet.data.temperature,
                        borderColor: getRandomColor(),
                        fill: false,
                    }
                );
            });

        if (combinedChart) {
            combinedChart.data.datasets = datasets;
            combinedChart.update();
        } else {
            combinedChart = new Chart(combinedCanvas.getContext('2d'), {
                type: 'line',
                data: {
                    datasets: datasets
                },
                options: {
                    scales: {
                        x: {
                            type: 'linear',
                            position: 'bottom'
                        }
                    },
                    elements: {
                        point:{
                            radius: 0
                        }
                    },
                    responsive: true,
                    maintainAspectRatio: true
                }
            });
            }
        }

    </script>
</body>
</html> 
